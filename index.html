

      const mode = document.getElementById("mode").value;
      const hijriOffset = parseInt(document.getElementById("hijriOffset").value || "0", 10);

      if(!d || !m || !y){
        out.innerHTML = "الرجاء إدخال اليوم والشهر والسنة";
        return;
      }

      let base; // moment object

      // 1) Create base moment from input (حسب نوع الإدخال)
      if(mode === "g2b" || mode === "g2h"){
        // input Gregorian
        base = moment(`${y}-${pad2(m)}-${pad2(d)}`, "YYYY-MM-DD", true);
      } else if(mode === "b2g" || mode === "b2h"){
        // input Babylon = Jalali numbers (نفس الجلالي رقمياً)
        // month هنا رقم 1..12
        base = moment(`${y}/${m}/${d}`, "jYYYY/jM/jD", true);
      } else if(mode === "h2g" || mode === "h2b"){
        // input Hijri
        base = moment(`${y}/${m}/${d}`, "iYYYY/iM/iD", true).add(hijriOffset, "days");
      } else {
        out.innerHTML = "وضع التحويل غير معروف";
        return;
      }

      if(!base.isValid()){
        out.innerHTML = "تاريخ غير صحيح. تأكد من الأرقام (اليوم/الشهر/السنة).";
        return;
      }

      // 2) Output conversion
      if(mode === "g2b"){
        const mJ = base.clone(); // same moment
        out.innerHTML = `النتيجة (بابلي شمسي): ${formatBabylonFromMoment(mJ)}`;
        return;
      }

      if(mode === "b2g"){
        out.innerHTML = `النتيجة (ميلادي): ${base.format("YYYY-MM-DD")}`;
        return;
      }

      if(mode === "g2h"){
        const h = base.clone().add(-hijriOffset, "days"); // حتى يبقى نفس التصحيح بالعكس
        out.innerHTML = `النتيجة (هجري قمري): ${h.format("iYYYY/iM/iD")}`;
        return;
      }

      if(mode === "h2g"){
        out.innerHTML = `النتيجة (ميلادي): ${base.format("YYYY-MM-DD")}`;
        return;
      }

      if(mode === "b2h"){
        const h = base.clone().add(-hijriOffset, "days");
        out.innerHTML =
          `النتيجة (هجري قمري): ${h.format("iYYYY/iM/iD")}<br>` +
          `<span class="small">ملاحظة: "بابلي شمسي" هنا = جلالي بالأرقام لكن بأسماء أشهر بابليّة.</span>`;
        return;
      }

      if(mode === "h2b"){
        const mJ = base.clone(); // بعد التصحيح
        out.innerHTML = `النتيجة (بابلي شمسي): ${formatBabylonFromMoment(mJ)}`;
        return;
      }
    }
  </script>
</body>
</html>
